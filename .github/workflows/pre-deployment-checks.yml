name: Pre-Deployment Documentation Checks

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  documentation-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Check CHANGELOG.md exists
      run: |
        if [ ! -f "CHANGELOG.md" ]; then
          echo "âŒ CHANGELOG.md not found in root directory"
          exit 1
        fi
        echo "âœ… CHANGELOG.md found"
    
    - name: Validate CHANGELOG format
      run: |
        # Check for proper format
        if ! grep -q "## \[Unreleased\]" CHANGELOG.md; then
          echo "âŒ CHANGELOG.md missing [Unreleased] section"
          exit 1
        fi
        echo "âœ… CHANGELOG.md format is valid"
    
    - name: Check for recent commits in CHANGELOG
      run: |
        # Get commits since last tag
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "HEAD~10")
        RECENT_COMMITS=$(git log --oneline $LAST_TAG..HEAD --grep="^feat\|^fix\|^BREAKING" | wc -l)
        
        if [ $RECENT_COMMITS -gt 0 ]; then
          echo "âš ï¸  Found $RECENT_COMMITS significant commits since last release"
          echo "Please ensure CHANGELOG.md is updated before deployment"
          
          # List the commits
          echo "Recent significant commits:"
          git log --oneline $LAST_TAG..HEAD --grep="^feat\|^fix\|^BREAKING"
        else
          echo "âœ… No significant commits requiring changelog updates"
        fi
    
    - name: Check documentation links
      run: |
        # Check for broken internal links in README
        if grep -q "\[.*\](docs/" README.md; then
          echo "âœ… README.md links to docs/ directory"
        else
          echo "âš ï¸  README.md may be missing documentation links"
        fi
    
    - name: Lint and build
      run: |
        npm run lint
        npm run build
    
    - name: Generate deployment summary
      run: |
        echo "## ðŸ“‹ Pre-Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| CHANGELOG.md exists | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| Documentation links | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| Lint checks | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| Build successful | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Ready for deployment! ðŸš€" >> $GITHUB_STEP_SUMMARY